#!/usr/bin/env python3
"""httpdumpd - リクエスト内容をダンプするシンプルな HTTP サーバー"""

import argparse
import sys
from http.server import HTTPServer, BaseHTTPRequestHandler


class DumpHandler(BaseHTTPRequestHandler):
    def do_any(self):
        print("------------------------------------------------>>")
        query = f"?{self.path.split('?', 1)[1]}" if '?' in self.path else ""
        path = self.path.split('?', 1)[0]
        print(f"{self.command} {path}{query} {self.request_version}")

        print("Request Headers:")
        for name, value in self.headers.items():
            print(f"{name}: {value}")

        content_length = int(self.headers.get("Content-Length", 0))
        if content_length > 0:
            body = self.rfile.read(content_length)
            print()
            print(body.decode("utf-8", errors="replace"))

        self.send_response(200)
        self.send_header("Content-Type", "text/plain")
        self.end_headers()
        self.wfile.write(b"OK")
        print("<<------------------------------------------------")

    do_GET = do_any
    do_POST = do_any
    do_PUT = do_any
    do_DELETE = do_any
    do_PATCH = do_any
    do_HEAD = do_any
    do_OPTIONS = do_any


def main():
    parser = argparse.ArgumentParser(description="httpdumpd - Simple HTTP server to dump request details")
    parser.add_argument("-p", "--port", type=int, default=5000, help="Port to listen on (default: 5000)")
    args = parser.parse_args()

    server = HTTPServer(("", args.port), DumpHandler)
    print(f"Listening on port {args.port}...")
    try:
        server.serve_forever()
    except KeyboardInterrupt:
        print("\nShutting down.")
        server.server_close()


if __name__ == "__main__":
    main()
