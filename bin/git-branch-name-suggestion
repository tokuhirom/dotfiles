#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "openai>=1.101.0",
# ]
# ///


import argparse
import os
import subprocess
import sys
from openai import OpenAI


def get_git_diff():
    """Execute git diff -w and return the output."""
    try:
        result = subprocess.run(
            ["git", "diff", "-w"],
            capture_output=True,
            text=True,
            check=True
        )
        return result.stdout
    except subprocess.CalledProcessError as e:
        print(f"Failed to get git diff: {e}", file=sys.stderr)
        sys.exit(1)


def generate_branch_name(git_diff, model):
    """Generate a branch name based on git diff using OpenAI API."""
    # OpenAI client automatically reads OPENAI_API_KEY and OPENAI_BASE_URL from environment
    client = OpenAI()
    
    system_prompt = """You are a Git branch name generator. Based on the provided git diff, generate a concise and descriptive branch name.
Rules for branch naming:
- Use lowercase letters
- Use hyphens to separate words
- Keep it short but descriptive (max 50 characters)
- Start with a prefix like: feat/, fix/, refactor/, docs/, test/, chore/
- Be specific about what changes are being made
- Only output the branch name, nothing else"""
    
    user_prompt = f"Generate a git branch name for the following changes:\n\n{git_diff}"
    
    try:
        completion = client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            temperature=0.7,
            max_tokens=100
        )
        
        if not completion.choices:
            print("No choices returned from API", file=sys.stderr)
            sys.exit(1)
            
        return completion.choices[0].message.content.strip()
    
    except Exception as e:
        print(f"Failed to generate completion: {e}", file=sys.stderr)
        sys.exit(1)


def main():
    parser = argparse.ArgumentParser(description="Generate git branch names based on git diff")
    parser.add_argument(
        "-model",
        type=str,
        default="gpt-4o-mini",
        help="Model to use for generating branch name (default: gpt-4o-mini)"
    )
    args = parser.parse_args()
    
    git_diff = get_git_diff()
    
    if not git_diff:
        print("No changes detected in git diff")
        sys.exit(0)
    
    branch_name = generate_branch_name(git_diff, args.model)
    print(branch_name)


if __name__ == "__main__":
    main()

