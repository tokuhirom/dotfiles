#!/bin/bash
set -e

if [[ "$#" -lt 1 ]]; then
    echo "Usage: ss-login HOST args..."
    exit 1
fi

host=$1
if [ -e $HOME/.linepw ]; then
    passwd=$(cat ~/.linepw | perl -pe 's/\n//g')
else
    passwd=$(security find-generic-password -gs kerberos -w)
fi

shift

# login(i need cache for this)
echo "$passwd" | ssh -t igw1.linecorp.com "cat /dev/stdin | kinit -f;" > /dev/null
# run
if [ -e /git-bash.exe ]; then
    echo Maybe the pipe in git-bash was broken....
    echo run following command:
    echo
    echo ssh igw1.linecorp.com -t "ssh 'irteamsu@$host'" $*
else
    exec ssh igw1.linecorp.com -t "ssh 'irteamsu@$host'" $*
fi

